<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMPLEO SCS - Gesti√≥n de Noticias de Empleo (Gratuito)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --scs-blue: #0066CC;
            --scs-blue-dark: #004d99;
        }
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s; }
        .dark { background-color: #0f172a; color: #f8fafc; }
        .sidebar-link.active { background-color: var(--scs-blue); color: white; border-radius: 0.5rem; }
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .loader { border-top-color: var(--scs-blue); animation: spinner 0.6s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Markdown-like styles for AI summary */
        .ai-content strong { font-weight: 700; color: #4b5563; }
        .dark .ai-content strong { color: #d1d5db; }
        .ai-content ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.5rem; }
        .ai-content li { margin-bottom: 0.25rem; }

        /* Chat Widget Styles */
        .chat-message { max-width: 80%; padding: 0.75rem 1rem; border-radius: 1rem; margin-bottom: 0.5rem; font-size: 0.875rem; line-height: 1.4; }
        .chat-user { background-color: var(--scs-blue); color: white; align-self: flex-end; border-bottom-right-radius: 0.25rem; }
        .chat-ai { background-color: #f3f4f6; color: #1f2937; align-self: flex-start; border-bottom-left-radius: 0.25rem; }
        .dark .chat-ai { background-color: #334155; color: #f8fafc; }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 antialiased overflow-x-hidden">

    <!-- Mobile Navigation Overlay -->
    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden backdrop-blur-sm transition-opacity"></div>

    <div class="flex min-h-screen">
        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 bg-white dark:bg-slate-900 shadow-xl transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out border-r border-gray-200 dark:border-slate-800 flex flex-col h-full">
            <div class="p-6 flex flex-col h-full">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-blue-500/30">E</div>
                        <div>
                            <h1 class="font-bold text-xl leading-tight tracking-tight">EMPLEO SCS</h1>
                            <p class="text-[10px] text-blue-600 dark:text-blue-400 uppercase tracking-widest font-bold">Canarias Oficial</p>
                        </div>
                    </div>
                    <!-- Close button for mobile -->
                    <button onclick="toggleSidebar()" class="lg:hidden text-gray-500 hover:text-blue-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Main Menu -->
                <nav class="flex-1 space-y-1 overflow-y-auto pr-2 custom-scrollbar">
                    <button onclick="switchTab('noticias')" class="sidebar-link active w-full flex items-center gap-3 px-4 py-3 text-sm font-bold transition-colors hover:bg-gray-100 dark:hover:bg-slate-800 uppercase" data-tab="noticias">
                        <i class="fas fa-bolt-lightning w-5"></i> NOTICIAS
                    </button>
                    <button onclick="switchTab('estabilizacion2022')" class="sidebar-link w-full flex items-center justify-between px-4 py-3 text-sm font-bold transition-colors hover:bg-gray-100 dark:hover:bg-slate-800 uppercase" data-tab="estabilizacion2022">
                        <span class="flex items-center gap-3 text-left"><i class="fas fa-shield-halved w-5"></i> ESTABILIZACI√ìN 2022</span>
                        <span class="bg-gray-100 dark:bg-slate-800 text-[10px] px-2 py-0.5 rounded font-normal normal-case" id="count-estabilizacion2022">0</span>
                    </button>
                    <button onclick="switchTab('convocatoria2025')" class="sidebar-link w-full flex items-center justify-between px-4 py-3 text-sm font-bold transition-colors hover:bg-gray-100 dark:hover:bg-slate-800 uppercase" data-tab="convocatoria2025">
                        <span class="flex items-center gap-3"><i class="fas fa-calendar-check w-5"></i> CONVOCATORIA 2025</span>
                        <span class="bg-gray-100 dark:bg-slate-800 text-[10px] px-2 py-0.5 rounded font-normal normal-case" id="count-convocatoria2025">0</span>
                    </button>
                    <button onclick="switchTab('supletorias')" class="sidebar-link w-full flex items-center justify-between px-4 py-3 text-sm font-bold transition-colors hover:bg-gray-100 dark:hover:bg-slate-800 uppercase" data-tab="supletorias">
                        <span class="flex items-center gap-3"><i class="fas fa-list-ol w-5"></i> LISTAS SUPLETORIAS</span>
                        <span class="bg-gray-100 dark:bg-slate-800 text-[10px] px-2 py-0.5 rounded font-normal normal-case" id="count-supletorias">0</span>
                    </button>
                    <button onclick="switchTab('traslados')" class="sidebar-link w-full flex items-center justify-between px-4 py-3 text-sm font-bold transition-colors hover:bg-gray-100 dark:hover:bg-slate-800 uppercase" data-tab="traslados">
                        <span class="flex items-center gap-3 text-left"><i class="fas fa-arrows-rotate w-5"></i> CONCURSO DE TRASLADO</span>
                        <span class="bg-gray-100 dark:bg-slate-800 text-[10px] px-2 py-0.5 rounded font-normal normal-case" id="count-traslados">0</span>
                    </button>
                    <button onclick="switchTab('otras')" class="sidebar-link w-full flex items-center justify-between px-4 py-3 text-sm font-bold transition-colors hover:bg-gray-100 dark:hover:bg-slate-800 uppercase" data-tab="otras">
                        <span class="flex items-center gap-3"><i class="fas fa-folder-open w-5"></i> OTRAS CONVOCATORIAS</span>
                        <span class="bg-gray-100 dark:bg-slate-800 text-[10px] px-2 py-0.5 rounded font-normal normal-case" id="count-otras">0</span>
                    </button>
                    
                    <div class="pt-4 mt-4 border-t border-gray-100 dark:border-slate-800">
                        <p class="px-4 text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Herramientas IA</p>
                        
                        <!-- Gemini Feature: Study Assistant Button -->
                        <button onclick="openStudyAssistant()" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium transition-colors hover:bg-gray-100 dark:hover:bg-slate-800 text-purple-600 dark:text-purple-400 group">
                            <i class="fas fa-brain w-5 group-hover:scale-110 transition-transform"></i> Asistente de Estudio ‚ú®
                        </button>
                        
                        <!-- Gemini Feature: Chat Mentor Button -->
                        <button onclick="toggleChat()" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium transition-colors hover:bg-gray-100 dark:hover:bg-slate-800 text-teal-600 dark:text-teal-400 group">
                            <i class="fas fa-comments w-5 group-hover:scale-110 transition-transform"></i> Chat Mentor SCS ‚ú®
                        </button>
                    </div>
                </nav>

                <div class="mt-auto pt-6 border-t border-gray-100 dark:border-slate-800 flex justify-between items-center">
                    <button onclick="toggleDarkMode()" class="p-3 rounded-xl bg-gray-50 dark:bg-slate-800 text-gray-500 hover:text-blue-600 transition-colors">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:block"></i>
                    </button>
                    <button class="text-xs text-gray-400 font-medium hover:underline">Soporte t√©cnico</button>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 lg:ml-72 p-4 md:p-10 transition-all duration-300">
            <!-- Header Bar -->
            <header class="flex flex-col gap-4 mb-10">
                <!-- Top Row: Mobile Menu + Search -->
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="lg:hidden p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm text-gray-600 dark:text-gray-300">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    
                    <div class="relative flex-1">
                        <input type="text" id="global-search" oninput="handleSearch(this.value)" placeholder="Buscar por categor√≠a, resoluci√≥n o cargo..." 
                            class="w-full pl-12 pr-4 py-4 rounded-2xl border-0 bg-white dark:bg-slate-800 focus:ring-2 focus:ring-blue-500 outline-none transition-all shadow-xl shadow-gray-200/50 dark:shadow-none">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <!-- Title & Contextual Subscribe -->
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 animate-in fade-in slide-in-from-left duration-500">
                    <div>
                        <h2 id="view-title" class="text-3xl md:text-4xl font-extrabold tracking-tight">NOTICIAS</h2>
                        <p id="view-desc" class="text-gray-500 dark:text-gray-400 mt-1">Sincronizaci√≥n en tiempo real con el BOC y Portal SCS.</p>
                    </div>
                    
                    <!-- Subscribe Button (Specific to current category) -->
                    <button onclick="showSpecificSubscribeModal()" id="subscribe-category-btn" class="flex items-center gap-2 px-5 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition-all whitespace-nowrap">
                        <i class="fas fa-bell"></i> 
                        <span id="subscribe-btn-text">Recibir avisos NOTICIAS</span>
                    </button>
                </div>
            </header>

            <!-- Filters (Quick Access) -->
            <div id="filter-container" class="flex flex-wrap gap-2 mb-8 overflow-x-auto pb-2 scrollbar-hide">
                <button onclick="filterByCategory('all')" class="category-btn active bg-blue-600 text-white px-5 py-2.5 rounded-full text-xs font-bold shadow-lg shadow-blue-500/20 whitespace-nowrap">Todas las fuentes</button>
                <button onclick="filterByCategory('SCS')" class="category-btn bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 px-5 py-2.5 rounded-full text-xs font-bold whitespace-nowrap">Portal SCS</button>
                <button onclick="filterByCategory('BOC')" class="category-btn bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 px-5 py-2.5 rounded-full text-xs font-bold whitespace-nowrap">BOC</button>
            </div>

            <!-- Posts Grid -->
            <div id="posts-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
                <!-- Injected via JS -->
            </div>
        </main>
    </div>

    <!-- SPECIFIC CATEGORY SUBSCRIBE MODAL -->
    <div id="alerts-panel" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[65] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-xl rounded-3xl shadow-2xl p-8">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-2xl font-black flex items-center gap-3">
                        <i class="fas fa-envelope-open-text text-blue-600"></i> Alertas Gratuitas
                    </h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Recibe avisos solo de lo que te interesa.</p>
                </div>
                <button onclick="hideAlertsPanel()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">Tu Correo Electr√≥nico</label>
                    <input type="email" id="subscribe-email" placeholder="tu@email.com" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-slate-800 border-0 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>

                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800">
                    <label class="block text-xs font-bold text-blue-600 dark:text-blue-400 uppercase tracking-widest mb-2">Categor√≠a Seleccionada</label>
                    <div class="flex items-center gap-2 text-lg font-bold">
                        <i class="fas fa-check-circle text-blue-600"></i>
                        <span id="modal-category-name">NOTICIAS</span>
                    </div>
                </div>
                
                <button onclick="confirmSubscription()" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-xl shadow-blue-500/20 hover:bg-blue-700 transition-all flex justify-center items-center gap-2">
                    <span>Activar Alertas</span> <i class="fas fa-arrow-right"></i>
                </button>

                <p class="text-[10px] text-center text-gray-400">
                    Al suscribirte aceptas recibir notificaciones relacionadas con esta categor√≠a. Puedes darte de baja en cualquier momento. Servicio 100% gratuito.
                </p>
            </div>
        </div>
    </div>

    <!-- GEMINI STUDY ASSISTANT MODAL -->
    <div id="study-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-2xl rounded-3xl shadow-2xl p-8 relative border border-purple-100 dark:border-purple-900">
             <!-- Background decoration -->
            <div class="absolute top-0 right-0 w-32 h-32 bg-purple-200 dark:bg-purple-900/30 rounded-full blur-3xl -z-10"></div>

            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black flex items-center gap-3 text-slate-800 dark:text-white">
                    <i class="fas fa-brain text-purple-600"></i> Asistente de Estudio <span class="text-xs bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300 px-2 py-1 rounded-full">BETA</span>
                </h3>
                <button onclick="closeStudyAssistant()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>

            <p class="text-gray-600 dark:text-gray-300 mb-6">Genera preguntas tipo test de examen sobre cualquier temario sanitario para practicar.</p>
            
            <div class="flex gap-2 mb-6">
                <input type="text" id="study-topic" placeholder="Ej: Ley General de Sanidad, RCP B√°sica, Calendario Vacunal..." 
                    class="flex-1 p-4 rounded-xl bg-gray-50 dark:bg-slate-800 border-2 border-transparent focus:border-purple-500 outline-none transition-colors"
                    onkeypress="if(event.key === 'Enter') generateQuestion()">
                <button onclick="generateQuestion()" id="generate-btn" class="px-6 py-4 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition-all shadow-lg shadow-purple-500/20 whitespace-nowrap">
                    Generar Pregunta ‚ú®
                </button>
            </div>

            <!-- Quiz Container -->
            <div id="quiz-container" class="hidden space-y-4">
                <div class="p-6 bg-slate-50 dark:bg-slate-800/50 rounded-2xl border border-gray-100 dark:border-slate-700">
                    <h4 id="quiz-question" class="text-lg font-bold mb-4 leading-relaxed">¬ø...?</h4>
                    <div id="quiz-options" class="space-y-3">
                        <!-- Options injected here -->
                    </div>
                </div>
                
                <div id="quiz-explanation-box" class="hidden p-5 bg-green-50 dark:bg-green-900/10 border border-green-100 dark:border-green-900 rounded-xl animate-in fade-in slide-in-from-top-2">
                    <h5 class="font-bold text-green-800 dark:text-green-400 mb-1 flex items-center gap-2"><i class="fas fa-check-circle"></i> Explicaci√≥n Correcta</h5>
                    <p id="quiz-explanation" class="text-sm text-green-700 dark:text-green-300 leading-relaxed"></p>
                </div>
            </div>

            <div id="quiz-loading" class="hidden py-12 flex-col items-center justify-center text-center">
                <div class="w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mb-4"></div>
                <p class="text-purple-600 font-medium animate-pulse">Gemini est√° redactando tu pregunta...</p>
            </div>
        </div>
    </div>

    <!-- NEW: GEMINI CHAT MENTOR WIDGET -->
    <div id="chat-widget" class="fixed bottom-6 right-6 z-[80] flex flex-col items-end pointer-events-none">
        <!-- Chat Window -->
        <div id="chat-window" class="pointer-events-auto bg-white dark:bg-slate-800 w-80 sm:w-96 h-[32rem] rounded-3xl shadow-2xl border border-gray-100 dark:border-slate-700 mb-4 transform translate-y-10 opacity-0 transition-all duration-300 origin-bottom-right hidden flex flex-col overflow-hidden">
            <!-- Header -->
            <div class="bg-teal-600 p-4 text-white flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-robot text-sm"></i></div>
                    <div>
                        <h4 class="font-bold text-sm">Mentor SCS</h4>
                        <p class="text-[10px] opacity-80 flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span> En l√≠nea (Gemini)</p>
                    </div>
                </div>
                <button onclick="toggleChat()" class="text-white/80 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- Messages Area -->
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4 bg-gray-50 dark:bg-slate-900/50">
                <!-- Initial Message -->
                <div class="flex flex-col items-start">
                    <div class="chat-message chat-ai shadow-sm">
                        ¬°Hola! Soy tu mentor virtual para las oposiciones del SCS. üè• <br><br>Preg√∫ntame sobre baremos, listas supletorias, temarios o cualquier duda del proceso.
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-3 bg-white dark:bg-slate-800 border-t border-gray-100 dark:border-slate-700 flex gap-2">
                <input type="text" id="chat-input" placeholder="Escribe tu duda..." class="flex-1 px-4 py-2 bg-gray-100 dark:bg-slate-900 rounded-full text-sm outline-none focus:ring-2 focus:ring-teal-500" onkeypress="if(event.key === 'Enter') sendChatMessage()">
                <button onclick="sendChatMessage()" class="w-10 h-10 bg-teal-600 text-white rounded-full flex items-center justify-center hover:bg-teal-700 transition-colors shadow-lg shadow-teal-500/30">
                    <i class="fas fa-paper-plane text-xs"></i>
                </button>
            </div>
        </div>

        <!-- Float Button -->
        <button onclick="toggleChat()" class="pointer-events-auto w-14 h-14 bg-teal-600 text-white rounded-full shadow-2xl flex items-center justify-center hover:scale-110 transition-transform hover:bg-teal-700 group relative">
            <i class="fas fa-comment-medical text-2xl group-hover:rotate-12 transition-transform"></i>
            <span class="absolute top-0 right-0 w-4 h-4 bg-red-500 rounded-full border-2 border-white dark:border-slate-900"></span>
        </button>
    </div>

    <script>
        // --- CONFIG ---
        const apiKey = "AIzaSyAmGRt_qQuYxnp3KoqV3Q_OCMw8_pwONs4"; 

        // --- DATA & STATE ---
        const MOCK_DATA = [
            // Estabilizaci√≥n 2022
            { id: 101, tab: 'estabilizacion2022', category: 'SCS', title: "Resoluci√≥n Listas Definitivas Estabilizaci√≥n Celadores", date: "2025-10-12", excerpt: "Publicada la relaci√≥n definitiva de personas aspirantes que superan el concurso-oposici√≥n extraordinario.", status: "nuevo", link: "#" },
            { id: 102, tab: 'estabilizacion2022', category: 'BOC', title: "BOC: Nombramiento Personal Estatutario Auxiliar Enfermer√≠a", date: "2025-10-10", excerpt: "Nombramiento como personal estatutario fijo de los aspirantes que han superado el proceso de estabilizaci√≥n 2022.", status: "actualizado", link: "#" },
            
            // Convocatoria 2025
            { id: 201, tab: 'convocatoria2025', category: 'SCS', title: "Publicaci√≥n Temarios Oficiales OPE 2025", date: "2025-11-01", excerpt: "Ya se pueden consultar los temarios actualizados para todas las categor√≠as t√©cnicas superiores de la OPE 2025.", status: "nuevo", link: "#" },
            { id: 202, tab: 'convocatoria2025', category: 'BOC', title: "Convocatoria 50 plazas T√©cnico Superior Laboratorio", date: "2025-11-05", excerpt: "Anuncio oficial en el BOC del proceso selectivo para ingreso por el sistema de acceso libre.", status: "urgente", link: "#" },

            // Supletorias
            { id: 301, tab: 'supletorias', category: 'SCS', title: "Apertura Lista Supletoria: Enfermer√≠a Quir√∫rgica", date: "2025-12-20", excerpt: "Se abre el plazo para la inscripci√≥n en las listas supletorias ante la falta de personal disponible en bolsa.", status: "nuevo", link: "#" },
            { id: 302, tab: 'supletorias', category: 'SCS', title: "Listas Provisionales Auxiliar Administrativo - Gerencia Dr. Negr√≠n", date: "2025-12-18", excerpt: "Consulta el listado provisional de admitidos y excluidos para la lista de empleo temporal.", status: "normal", link: "#" },

            // Traslados
            { id: 401, tab: 'traslados', category: 'BOC', title: "BOC: Concurso de Traslado Voluntario Fisioterapeutas", date: "2025-09-30", excerpt: "Convocatoria para la movilidad voluntaria de personal estatutario fijo en centros de salud de La Palma.", status: "normal", link: "#" },
            { id: 402, tab: 'traslados', category: 'SCS', title: "Adjudicaci√≥n Provisional Destinos Traslado M√©dico Familia", date: "2025-11-15", excerpt: "Publicada la propuesta de adjudicaci√≥n de plazas para el concurso de traslados 2024-2025.", status: "actualizado", link: "#" },

            // Otras
            { id: 501, tab: 'otras', category: 'GOOGLE', title: "Bolsa externa de T√©cnicos Inform√°ticos para el SCS", date: "2025-12-05", excerpt: "Convenio con universidades canarias para la captaci√≥n de talento en el √°rea de sistemas de informaci√≥n.", status: "nuevo", link: "#" }
        ];

        let state = {
            currentTab: 'noticias',
            searchQuery: '',
            filterCategory: 'all',
            viewedIds: []
        };

        const CATEGORY_NAMES = {
            'noticias': 'NOTICIAS',
            'estabilizacion2022': 'ESTABILIZACI√ìN 2022',
            'convocatoria2025': 'CONVOCATORIA 2025',
            'supletorias': 'LISTAS SUPLETORIAS',
            'traslados': 'CONCURSO DE TRASLADO',
            'otras': 'OTRAS CONVOCATORIAS'
        };

        // --- GEMINI API HELPERS ---

        async function callGeminiAPI(payload) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const delays = [1000, 2000, 4000, 8000, 16000];

            for (let i = 0; i < delays.length; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    return data;
                } catch (error) {
                    if (i === delays.length - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delays[i]));
                }
            }
        }

        // --- FEATURE: AI SUMMARY ---

        async function summarizePost(id, title) {
            const container = document.getElementById(`summary-${id}`);
            
            // Toggle visibility if already loaded
            if (container.innerHTML !== '' && !container.classList.contains('hidden')) {
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');

            // Show Loading
            container.innerHTML = `
                <div class="flex items-center gap-3 text-purple-600">
                    <div class="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"></div>
                    <span class="text-xs font-bold animate-pulse">Analizando documento...</span>
                </div>
            `;

            try {
                // In a real app, we would fetch the PDF content. Here we simulate based on title.
                const prompt = `Eres un experto en empleo p√∫blico sanitario en Canarias. Resume brevemente la siguiente noticia para un opositor, extrayendo plazos, requisitos o acciones a tomar en formato de lista (bullet points). Noticia: "${title}".`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }]
                };

                const data = await callGeminiAPI(payload);
                const text = data.candidates[0].content.parts[0].text;

                // Simple formatting conversion (markdown bold to html strong)
                const formattedText = text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\* /g, '<li>')
                    .replace(/\n/g, '<br>');

                container.innerHTML = `
                    <div class="ai-content">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-bold text-purple-600 uppercase tracking-widest">Resumen Gemini</span>
                            <i class="fas fa-sparkles text-purple-400"></i>
                        </div>
                        <div class="text-slate-700 dark:text-slate-300 leading-relaxed text-xs">
                            ${formattedText}
                        </div>
                    </div>
                `;
            } catch (err) {
                container.innerHTML = `<p class="text-red-500 text-xs">Error al generar resumen. Int√©ntalo de nuevo.</p>`;
                console.error(err);
            }
        }

        // --- FEATURE: AI STUDY ASSISTANT ---

        let currentQuizAnswer = null;

        function openStudyAssistant() {
            document.getElementById('study-modal').classList.remove('hidden');
            document.getElementById('study-modal').classList.add('flex');
            document.getElementById('study-topic').focus();
        }

        function closeStudyAssistant() {
            document.getElementById('study-modal').classList.add('hidden');
            document.getElementById('study-modal').classList.remove('flex');
        }

        async function generateQuestion() {
            const topic = document.getElementById('study-topic').value;
            if(!topic) return;

            // UI State
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('quiz-loading').classList.remove('hidden');
            document.getElementById('quiz-loading').classList.add('flex');
            document.getElementById('generate-btn').disabled = true;
            document.getElementById('generate-btn').classList.add('opacity-50');

            try {
                const prompt = `Eres un preparador de oposiciones de sanidad. Genera una pregunta de tipo test dif√≠cil sobre el tema: '${topic}'. 
                Responde EXCLUSIVAMENTE con un objeto JSON v√°lido con este esquema:
                {
                    "question": "Texto de la pregunta",
                    "options": ["Opci√≥n A", "Opci√≥n B", "Opci√≥n C", "Opci√≥n D"],
                    "correctIndex": 0,
                    "explanation": "Explicaci√≥n detallada de por qu√© es correcta."
                }`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                };

                const data = await callGeminiAPI(payload);
                
                // ROBUST PARSING FIX:
                // Gemini sometimes returns markdown blocks (```json ... ```) even when asked not to.
                // We must clean the string before parsing.
                let rawText = data.candidates[0].content.parts[0].text;
                rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();

                const result = JSON.parse(rawText);
                
                renderQuiz(result);

            } catch (err) {
                alert("Hubo un error generando la pregunta. Por favor intenta otro tema.");
                console.error(err);
                document.getElementById('quiz-loading').classList.add('hidden');
                document.getElementById('quiz-loading').classList.remove('flex');
            } finally {
                document.getElementById('generate-btn').disabled = false;
                document.getElementById('generate-btn').classList.remove('opacity-50');
            }
        }

        function renderQuiz(data) {
            document.getElementById('quiz-loading').classList.add('hidden');
            document.getElementById('quiz-loading').classList.remove('flex');
            document.getElementById('quiz-container').classList.remove('hidden');
            document.getElementById('quiz-explanation-box').classList.add('hidden');

            document.getElementById('quiz-question').innerText = data.question;
            currentQuizAnswer = data;

            const optsDiv = document.getElementById('quiz-options');
            optsDiv.innerHTML = '';

            data.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 rounded-xl border border-gray-200 dark:border-slate-600 hover:bg-purple-50 dark:hover:bg-purple-900/20 hover:border-purple-300 transition-all text-sm font-medium option-btn";
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(index, btn);
                optsDiv.appendChild(btn);
            });
        }

        function checkAnswer(selectedIndex, btnElement) {
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(b => b.disabled = true); // Disable all

            if (selectedIndex === currentQuizAnswer.correctIndex) {
                btnElement.classList.add('bg-green-100', 'border-green-500', 'text-green-800', 'dark:bg-green-900', 'dark:text-green-100');
                btnElement.innerHTML += ' <i class="fas fa-check float-right mt-1"></i>';
            } else {
                btnElement.classList.add('bg-red-100', 'border-red-500', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-100');
                btnElement.innerHTML += ' <i class="fas fa-times float-right mt-1"></i>';
                
                // Highlight correct
                const correctBtn = buttons[currentQuizAnswer.correctIndex];
                correctBtn.classList.add('bg-green-50', 'border-green-500', 'dark:bg-green-900/30');
                correctBtn.innerHTML += ' <i class="fas fa-check float-right mt-1 opacity-50"></i>';
            }

            // Show explanation
            const expBox = document.getElementById('quiz-explanation-box');
            document.getElementById('quiz-explanation').innerText = currentQuizAnswer.explanation;
            expBox.classList.remove('hidden');
        }

        // --- FEATURE: CHAT MENTOR SCS ---

        let isChatOpen = false;

        function toggleChat() {
            const window = document.getElementById('chat-window');
            if (isChatOpen) {
                window.classList.add('hidden');
                window.classList.add('opacity-0', 'translate-y-10');
            } else {
                window.classList.remove('hidden');
                // Small delay to allow display block to apply before opacity transition
                setTimeout(() => {
                    window.classList.remove('opacity-0', 'translate-y-10');
                }, 10);
                document.getElementById('chat-input').focus();
            }
            isChatOpen = !isChatOpen;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            // UI Add User Message
            addMessageToChat(msg, 'user');
            input.value = '';

            // Add Loading Indicators
            const loadingId = addLoadingToChat();

            try {
                const prompt = `Act√∫a como un mentor experto y amable en las Oposiciones del Servicio Canario de Salud (SCS). 
                Responde brevemente a esta pregunta de un opositor: "${msg}". 
                Si la pregunta no es sobre oposiciones o sanidad, responde educadamente que solo sabes de ese tema.`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }]
                };

                const data = await callGeminiAPI(payload);
                const reply = data.candidates[0].content.parts[0].text;

                // Remove loading and add response
                document.getElementById(loadingId).remove();
                addMessageToChat(reply, 'ai');

            } catch (err) {
                document.getElementById(loadingId).remove();
                addMessageToChat("Lo siento, hubo un error de conexi√≥n. Int√©ntalo de nuevo.", 'ai');
                console.error(err);
            }
        }

        function addMessageToChat(text, sender) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `flex flex-col ${sender === 'user' ? 'items-end' : 'items-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `chat-message shadow-sm ${sender === 'user' ? 'chat-user' : 'chat-ai'}`;
            // Simple markdown parsing
            bubble.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            
            div.appendChild(bubble);
            container.appendChild(div);
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function addLoadingToChat() {
            const container = document.getElementById('chat-messages');
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex flex-col items-start";
            div.innerHTML = `
                <div class="chat-message chat-ai shadow-sm flex gap-1 items-center h-8">
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        // --- CORE FUNCTIONS ---

        function init() {
            // We removed loadState premium check here
            renderPosts();
            updateCounts();
        }

        function renderPosts() {
            const grid = document.getElementById('posts-grid');
            let filtered = MOCK_DATA.filter(item => {
                const matchesTab = state.currentTab === 'noticias' ? true : item.tab === state.currentTab;
                const matchesSearch = item.title.toLowerCase().includes(state.searchQuery) || item.excerpt.toLowerCase().includes(state.searchQuery);
                const matchesCat = state.filterCategory === 'all' ? true : item.category === state.filterCategory;
                return matchesTab && matchesSearch && matchesCat;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));

            grid.innerHTML = '';
            filtered.forEach(post => {
                const card = createCard(post);
                grid.appendChild(card);
            });
        }

        function createCard(post) {
            const div = document.createElement('div');
            // Premium logic removed - always unlocked
            
            div.className = "glass-card p-6 rounded-[2rem] flex flex-col h-full hover:shadow-2xl transition-all duration-500 relative group";
            
            const meta = {
                'SCS': { color: 'blue', label: 'Oficial SCS', icon: 'fa-hospital' },
                'BOC': { color: 'purple', label: 'BOC', icon: 'fa-file-signature' },
                'GOOGLE': { color: 'orange', label: 'Noticias', icon: 'fa-globe' }
            }[post.category];

            const aiButton = `
                <button id="btn-summary-${post.id}" onclick="event.stopPropagation(); summarizePost(${post.id}, '${post.title}')" 
                    class="mt-4 w-full py-2 bg-purple-50 dark:bg-purple-900/10 text-purple-600 dark:text-purple-300 rounded-lg text-xs font-bold border border-purple-100 dark:border-purple-900 hover:bg-purple-100 transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-magic"></i> Resumir con IA ‚ú®
                </button>
                <div id="summary-${post.id}" class="hidden mt-3 p-3 bg-white dark:bg-slate-800 rounded-lg border border-purple-100 dark:border-slate-700 shadow-sm"></div>
            `;

            div.innerHTML = `
                <div class="flex-1 flex flex-col">
                    <div class="flex justify-between items-start mb-5">
                        <span class="text-[10px] font-black uppercase tracking-[0.2em] text-${meta.color}-600">
                            <i class="fas ${meta.icon} mr-1"></i> ${meta.label}
                        </span>
                        <span class="px-3 py-1 rounded-full text-[9px] font-black uppercase ${getStatusStyle(post.status)}">
                            ${post.status}
                        </span>
                    </div>
                    <h3 class="text-xl font-black leading-tight mb-4 group-hover:text-blue-600 transition-colors">${post.title}</h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4 flex-1">${post.excerpt}</p>
                    
                    ${aiButton}

                    <div class="flex items-center justify-between pt-6 mt-2 border-t border-gray-100 dark:border-slate-800">
                        <span class="text-xs font-bold text-gray-400"><i class="far fa-calendar-alt mr-1"></i> ${new Date(post.date).toLocaleDateString()}</span>
                        <button onclick="viewPost(${post.id})" class="px-5 py-2.5 bg-gray-900 dark:bg-blue-600 text-white rounded-xl text-xs font-bold hover:scale-105 transition-transform">Ver PDF</button>
                    </div>
                </div>
            `;
            return div;
        }

        function getStatusStyle(s) {
            return {
                'nuevo': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400',
                'urgente': 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400',
                'actualizado': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400'
            }[s] || 'bg-gray-100 text-gray-600 dark:bg-slate-800 dark:text-gray-400';
        }

        function viewPost(id) {
            // Premium check removed
            const p = MOCK_DATA.find(x => x.id === id);
            if(p.link !== '#') window.open(p.link, '_blank');
            else alert("Funcionalidad de visualizaci√≥n de PDF abierta.");
        }

        // --- UI UPDATES ---

        function updateCounts() {
            ['estabilizacion2022', 'convocatoria2025', 'supletorias', 'traslados', 'otras'].forEach(tab => {
                const count = MOCK_DATA.filter(x => x.tab === tab).length;
                const el = document.getElementById(`count-${tab}`);
                if(el) el.innerText = count;
            });
        }

        function switchTab(tabId) {
            state.currentTab = tabId;
            document.querySelectorAll('.sidebar-link').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabId);
            });

            // Set Title dynamically
            const categoryName = CATEGORY_NAMES[tabId] || 'NOTICIAS';
            document.getElementById('view-title').innerText = categoryName;
            document.getElementById('subscribe-btn-text').innerText = `Recibir avisos ${categoryName}`;
            
            const filterBar = document.getElementById('filter-container');
            filterBar.classList.toggle('hidden', tabId !== 'noticias');

            renderPosts();
            if(window.innerWidth < 1024) toggleSidebar();
        }

        function handleSearch(v) {
            state.searchQuery = v.toLowerCase();
            renderPosts();
        }

        function filterByCategory(cat) {
            state.filterCategory = cat;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white');
                btn.classList.add('bg-white', 'dark:bg-slate-800', 'border');
            });
            event.target.classList.add('active', 'bg-blue-600', 'text-white');
            event.target.classList.remove('bg-white', 'dark:bg-slate-800', 'border');
            renderPosts();
        }

        // --- MODAL & FLOW CONTROLS ---

        function showSpecificSubscribeModal() {
             const categoryName = CATEGORY_NAMES[state.currentTab] || 'NOTICIAS';
             document.getElementById('modal-category-name').innerText = categoryName;
             
             document.getElementById('alerts-panel').classList.remove('hidden');
             document.getElementById('alerts-panel').classList.add('flex');
        }

        function hideAlertsPanel() {
            document.getElementById('alerts-panel').classList.add('hidden');
            document.getElementById('alerts-panel').classList.remove('flex');
        }
        
        function confirmSubscription() {
            const email = document.getElementById('subscribe-email').value;
            if(!email || !email.includes('@')) {
                alert("Por favor introduce un email v√°lido.");
                return;
            }
            const categoryName = CATEGORY_NAMES[state.currentTab] || 'NOTICIAS';
            alert(`‚úÖ ¬°Suscrito con √©xito!\n\nRecibir√°s alertas GRATUITAS sobre "${categoryName}" en: ${email}`);
            hideAlertsPanel();
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('-translate-x-full');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                overlay.classList.add('hidden');
            } else {
                overlay.classList.remove('hidden');
            }
        }

        window.onload = init;
    </script>
</body>
</html>
